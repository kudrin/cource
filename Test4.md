На самом деле, сложно подойти к этой домашке. Т.к. сервис получившийся в нулевой домашке мало отличается от сервиса в третьей.
Можно конечно, было взять в качестве изначальной схемы, то, что предложено, но хочется сэкономить свое время, т.к. к выполнению домашки смог приступить только во вторник.


**Было:**
![](https://documents.lucid.app/documents/ad67a0b2-f117-46e5-8dff-f41df47ec975/pages/~qgXeX-eI4DN?a=1261&x=-329&y=121&w=1518&h=1309&store=1&accept=image%2F*&auth=LCA%20e1f8a8ea6d33bf75fd96d59e3a0b1877785ff8d56181b6805a8a22fe77357144-ts%3D1683890294)

**Стало:**
![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/~dG2E08hpsg~?a=10600&x=-637&y=-442&w=3003&h=1573&store=1&accept=image%2F*&auth=LCA%20c15f5169e0ee0797ade111e9e245dc80accd33a9cde996e0b730cf9ae6f8831b-ts%3D1685452690)

Посчитаем instability
```
Test:
  0in 1out
  1/(1+0) = 1

Analytics:
  1in 0out
  0/(0+1) = 0

Matching:
  2in 1out
  1/(1+2) = 0.33
 
Orders
  2in 6out
  6/(2+6) = 6/8 = 3/4 = 0.75

Warehouse:
  1in 2out
  2/(2+1) = 0.66
  
Bets:
  1in 0out
  0/(0+1) = 0
 
Notify:
  Nin 0out = 0
  
Accouting:
  2in 1out
  1/(1+2) = 0.33
 
Processing 
  1in 2out
  2/(2+1) = 0.66
```

Получаем след результат.
![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=10816&x=-638&y=-442&w=3042&h=1573&store=1&accept=image%2F*&auth=LCA%2006dc509cf6e06252e8d13cfa968b855be16d4d3c0e60c257c933db6f398e043a-ts%3D1686058149)

У меня в ADR-001 было несколько вариантов решение с матчингом и системой заказов. Я пробую выбрать лучший вариант на основе инстабилити. И найду решение как к нему перейти.

>2.1) **СЛОЖНЫЙ** 2 отдельны базы и синхронизация через стриминг
	![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/VIK20Zggjd5J?a=10406&x=-529&y=905&w=869&h=449&store=1&accept=image%2F*&auth=LCA%201817835368ff4e3a00c146c9fdc0ef4298588b02e05cd65ceb1897837a5881fb-ts%3D1685452690)

>Но я бы не рассматривал этот вариант, реализовать стриминг не просто. А матчингу это не особо нужно, так как все его модели только для чтения. Перейти к такой реализации, мы можем только при высокой нагрузке или высоким требованиям по отказоустойчивости.

```
Matching: 
  3in 1out
  1/(1+3) = 0.25

Orders:
  2in 7out
  6/(2+7) = 6/9 = 0.66
```

Инстабилити улучшено для двух контекстов.

Для распила нам понадобится, добавить стриминг данных, и после досинхронизировать недостающие данные.



> 2.2 **ПРОСТОЙ** один сервис с одной базой.
	![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/VIK20Zggjd5J?a=10463&x=-524&y=907&w=759&h=408&store=1&accept=image%2F*&auth=LCA%208b49ca418e5e6cebcef0e548d7b00dbbfe1f8a9ab543e577f3a363d876712541-ts%3D1685452690)
	 И  этот подход может стать лучшим решением, если у нас одна команда работает с заказами и матчингом.

Тут придется посчитать инстабилити уже для объединенного сервиса.

```
Matching&Ordering

2in 4out
  3in 4out
  4/(4+2) = 0.66
```

Один сервис меньше 2х. И Максимальное значение уменьшилось, и это решение мне кажется более простым. С поравкой на 
> нас одна команда работает с заказами и матчингом.

Объеденить Эти 2 сервиса будет достаточно легко.

------------

Распил монолита.

Даже при достаточном количестве людей я бы не стал начинать с выноса кор домена, т.к. он самый сложный и подверженный изменению. Пока мы его будем выносить там может появиться столько фич, что мы не справимся. Поэтому я тут применяю смешанный подход.

**Шаг 1. Выносим сервис тестирования.**

Это важный сервис который подвергается изменениям, так как мы стремимся улучшить качество тестирования.

Мы заново напишем структуру данных. Более удобную для этого микросервиса. Но в рамках старого поддомена оставим модель воркера неизменной.

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=11039&x=-348&y=242&w=808&h=794&store=1&accept=image%2F*&auth=LCA%2095d41b989df4e95be32ce8e1cddeefbd169aa5a371186095b4c7d95b47a84b3d-ts%3D1686058149)



Шаг 2. Добавим сервис аккаунты

Он будет у нас отвечать за первичку внутри системы. Сверку надо будет осуществлять с 1С. Как мы убедимся что сервис аккаунтов буде работать корректно, мы будем считать его источником истины.

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=11039&x=666&y=-81&w=1158&h=530&store=1&accept=image%2F*&auth=LCA%20abb64d1a36ec07ca777a31fde497a21036bea86905cd8603d6d9eafebe0f580f-ts%3D1686058149)


**Шаг 3. Пишем новую логику биллинга.**

3.1 Напишем интеграцию со Шляпой.
3.2 Реализуем сервис инвойсы воркеров, т.к. требуется интеграция с одной платежной системой - Шляпой.
3.4 Реализуем сервис списания с клиентов, на первом этапе интеграция только с одной платежной системой - Шляпой.
3.5 - 3.n - интегрируем остальные платежные системы.

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=11039&x=1387&y=-140&w=920&h=876&store=1&accept=image%2F*&auth=LCA%200aeecce09690d78aa61aa6562c987c1314d0c10e3c912b7c6ced9012db71ea55-ts%3D1686058149)

**Шаг 4 Выносим логику работы со складом в отдельный адаптер.** 

Сначала выносим код, а потом заменяем коммуникацию на аснхронную.

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=11039&x=47&y=-392&w=726&h=475&store=1&accept=image%2F*&auth=LCA%2095e10682e9d47ae38f13a30e011dd714b7312ecca87332380b1c712406670bc0-ts%3D1686058149)


**Шаг 5. Выносим ставки.**

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/0TP4~9uXMOAj?a=11039&x=670&y=-377&w=1058&h=459&store=1&accept=image%2F*&auth=LCA%20bcfc9ea2bf61b09b49b8364a015cde1d46b66edd80772d6d872b02f679799dbc-ts%3D1686058149)

Шаг 6. 
Рефачим матчинг и заказы

Шаг 7. Увольняемся