# Выбор архитектурного стиля для Make cats free again

### **Status**: _Proposed_

## **Context**
Основываясь на требованиях и консёрнах стейкхолдеров, было определено, а так же на некоторых предположениях в области неявных требований. Предложено следущее решение. 

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/KH-1BF~jP.td?a=9853&x=55&y=257&w=3190&h=2266&store=1&accept=image%2F*&auth=LCA%20ac93ef644064cb679a26407116cd5f99197c7599f629edca3bce37455de32c94-ts%3D1685452690)

На основе основных характеристик Agility, Scalabilty, Modifability, Maintability можно сделать выводы о, том что нам подходит микросервисная архитектура.
Важно также понимать что любой сервис может стеать service-based. И каждый модуль стоит реализовывать слоями.
Базы везде используем реалиционные, как наиболее простое для разработчика решение.

![Все стили, которые будут рассматриваться для принятия решений](https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F81665a69-28d8-41d4-94db-b1490f0636f1%2FScreenshot_2023-04-22_at_05.04.32.jpg?table=block&id=d77d19d7-9e7e-4b8a-9c5f-b7f529437e9a&cache=v2)

Но поскольку это все таки стартап и многие гипотизы не проверенны, я предлагаю следующие решения. Которые помогут сэкономит время и деньги на начальном этапе.

![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/~dG2E08hpsg~?a=10584&x=-637&y=-439&w=3003&h=1507&store=1&accept=image%2F*&auth=LCA%204874962a68ccd095ba6e2dcd957a113514dc0ed227390075d368701e4c13537f-ts%3D1685452690)

0) Сервис **Auth** выходит за рамки данного урока, но мы можем найти готовое решение. Поскольку у нас микросервисы важно чтобы они помог рабоать с JWT токенами.
1) Результатами сервиса **Тестирование** будет пользоваться только **ордеринг** и **матчинг**, поэтому можем объединить в один service-layerd service
   ![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/VIK20Zggjd5J?a=9938&x=-373&y=0&w=1166&h=440&store=1&accept=image%2F*&auth=LCA%20596d239c7fd4001ab53860e95a08d2f5098fb330ee1825eab37076d5b0d95129-ts%3D1685452690)
   Но я бы сразу вынес эту логику в отдельный сервис. Хоть релизный цикл там и там будет высоким, я предполагаю, что он не будет совпадать по времени. И скорее всего с понимаем эффективности тестов, или матчинга релизный цикл может измениться для отдельного модуля.
   
   Базу используем реалиционноую, но можем подумать в сторону JSON-b для ответов.
   
2) **Сервис заказов** является оркестратором, этот сервис использует оркестрируемую топологию.
   В основной архитектуре я предлагаю, разделить это на два сервиса, причем асинхронного общения, согласованность данных, осуществляется только через read-only доступ. Минусом такого подхода могут стать асинхронное согласование, заказ создался, а ответ от мачинга не пришел.
   
   Но тут еще есть 2 подхода.
	2.1) **СЛОЖНЫЙ** 2 отдельны базы и синхронизация через стриминг
	![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/VIK20Zggjd5J?a=10406&x=-529&y=905&w=869&h=449&store=1&accept=image%2F*&auth=LCA%201817835368ff4e3a00c146c9fdc0ef4298588b02e05cd65ceb1897837a5881fb-ts%3D1685452690)
	Но я бы не рассматривал этот вариант, реализовать стриминг не просто. А матчингу это не особо нужно, так как все его модели только для чтения. Перейти к такой реализации, мы можем только при высокой нагрузке или высоким требованиям по отказоустойчивости отдельного компонента.
	2.2) **ПРОСТОЙ** один сервис с одной базой.
	![](https://documents.lucid.app/documents/b9ff6147-96bd-48cc-b6df-e697f70eba37/pages/VIK20Zggjd5J?a=10463&x=-524&y=907&w=759&h=408&store=1&accept=image%2F*&auth=LCA%208b49ca418e5e6cebcef0e548d7b00dbbfe1f8a9ab543e577f3a363d876712541-ts%3D1685452690)
	 И  этот подход может стать лучшим решением, если у нас одна команда работает с заказами и матчингом.
 
 3) Тут важно то, что мы выносим **адаптер для работы со складом**, в отдельный сервис, для того, чтобы была возможность реализовать прямые запросы воркеров к работникам склада. Печеньки и заказ-наряд, реализуем как просто складской инвентарь.
 4) **Ставки**. Отдельный сервис. Менеджеры хотят сделать его изолированным даже для разработчиков, возможно они смогут полностью его вести в Excel. Но возможно также стоит подумать об их увольнении. Тайные процессы, не лучшее проявление лояльности.
 5) **Accouting** - общий финансовый учет, в рамках системы. Общую бухгалтерию ведем в 1С - например деньги уборщицы. Двойная запись. Каждая проводка атомарна. Для получения баланса в моменте, можем сделать отдельную таблицу, обновляемую на уровне тразакций бд.
	 При расширении бизнеса мы захотим продавать другие услуги клиентам. Но списания раз в день, разделить с процессингом.
	 Месячные начисления до списания ведем как операционный счет. 
 6) Основная задача **процессингового центра** общаться с внешними платежками. В случае успешного платежа транзакция записывается в Accouting. Важно чтобы баланс был не нулевой, так что тут важна синхронная коммуникация. В требование говорят, что воркеры пользуются исключительно золотой шляпой. Но вдруг они передумают?
	  Расчет скидок также происходит тут.
 7) Каждую платежку подключаем через отдельный адаптер. Это позволит привлекать аутсорс, на разаботку. 
 8) Для нас основными метриками будут количество заказов. И скорость обработки на каждом из этапов. Также важны финансовые показатели, но их важнее смотреть в рамках компании, т.е. из 1с. В будущем наверное важно и качество тестов. Основными потребителями сервиса будут владельцы бизнеса, для них этот сервис важен.
 9) Сервис **нотификации** отвечает только за транспортный узел, и не содержит бизнес логики. Вынесение его в отдельный сервис, это позволит лего сможем сменить почтового провайдера, если письма будут плохо приходить. Но так же важно понимать, что воркеры пользуются мобильный приложением, им удобнее пуши. Свзяи доработать в дальнейшем. Все запросы к адаптеру асинхронные.
 10) В будущем логично прикрутить расчет воркеров также к системе **акакутинга**. Этот пример показывает почему важно разделение между **аккаутингом** и **процессингом**.

## **Сompliance**

Так как нет вариантов автоматической проверки реализации архитектурного стиля, важно отслеживать метрики по времени исполнения отдельной части заказа. Например если заказ долго обрабатывается складом, или остается в статусе сбора инвентаря, это намек приглядеться к сервису отвечающему за складскую интеграцию. 